stages:
  - deploy

deploy-docker-digitalocean:
  stage: deploy
  image: omnileads/doctl:230427.01
  variables: 
    DIGITALOCEAN_ACCESS_TOKEN: $DIGITALOCEAN_ACCESS_TOKEN
    DIGITALOCEAN_DROPLET_IMG: $DIGITALOCEAN_DROPLET_IMG
    DIGITALOCEAN_DROPLET_SIZE: $DIGITALOCEAN_DROPLET_SIZE
    DIGITALOCEAN_REGION: $DIGITALOCEAN_REGION
    DIGITALOCEAN_SSH_KEY: $DIGITALOCEAN_SSH_KEY
    CI_JOB_ID: $CI_JOB_ID
  script:
    - doctl auth init -t ${DIGITALOCEAN_ACCESS_TOKEN}
    - git clone --branch $CI_COMMIT_BRANCH https://gitlab.com/omnileads/omldeploytool.git
    - doctl compute droplet create --image ${DIGITALOCEAN_DROPLET_IMG} --size ${DIGITALOCEAN_DROPLET_SIZE} --region ${DIGITALOCEAN_REGION} --ssh-keys ${DIGITALOCEAN_SSH_KEY} --user-data-file ./omldeploytool/docker-compose/user-data.sh cicd-aio.${CI_JOB_ID}
    - sleep 30
    - OML_IPADDR=$(doctl compute droplet list |grep cicd-aio.${CI_JOB_ID} |awk '{print $3}') && echo "$OML_IPADDR to run tests"
    - until curl -sk --head --request GET https://$OML_IPADDR |grep "302" > /dev/null; do echo "Environment still being installed, sleeping 60 seconds"; sleep 60; done; echo "Environment is up"
    - sleep 120
    - doctl compute droplet delete -f cicd-aio.${CI_JOB_ID}
    - rm -rf ./omldeploytool
  only:
    - /.*pipeline-aio.*$/
    - /.*pipeline-all.*$/
    - schedules
    - web
    - merge_request


deploy-ait-digitalocean:
  stage: deploy
  environment: DOCTL_DIGITALOCEAN_SYSTEMD
  script:
    - doctl compute droplet create --image ${DIGITALOCEAN_DROPLET_IMG} --size ${DIGITALOCEAN_DROPLET_SIZE_SYSTEMD} --region ${DIGITALOCEAN_REGION} --ssh-keys ${DIGITALOCEAN_SSH_KEY} cicd-data.${CI_JOB_ID}
    - doctl compute droplet create --image ${DIGITALOCEAN_DROPLET_IMG} --size ${DIGITALOCEAN_DROPLET_SIZE_SYSTEMD} --region ${DIGITALOCEAN_REGION} --ssh-keys ${DIGITALOCEAN_SSH_KEY} cicd-voice.${CI_JOB_ID}
    - doctl compute droplet create --image ${DIGITALOCEAN_DROPLET_IMG} --size ${DIGITALOCEAN_DROPLET_SIZE_SYSTEMD} --region ${DIGITALOCEAN_REGION} --ssh-keys ${DIGITALOCEAN_SSH_KEY} cicd-app.${CI_JOB_ID}
    - sleep 60
    - OML_IPADDR_DATA=$(doctl compute droplet list |grep cicd-data.${CI_JOB_ID} |awk '{print $3}') && echo "$OML_IPADDR to run tests" 
    - OML_IPADDR_DATALAN=$(doctl compute droplet list |grep cicd-data.${CI_JOB_ID} |awk '{print $4}') && echo "$OML_IPADDR to run tests" 
    - OML_IPADDR_VOICE=$(doctl compute droplet list |grep cicd-voice.${CI_JOB_ID} |awk '{print $3}') && echo "$OML_IPADDR to run tests" 
    - OML_IPADDR_VOICELAN=$(doctl compute droplet list |grep cicd-voice.${CI_JOB_ID} |awk '{print $4}') && echo "$OML_IPADDR to run tests" 
    - OML_IPADDR_APP=$(doctl compute droplet list |grep cicd-app.${CI_JOB_ID} |awk '{print $3}') && echo "$OML_IPADDR to run tests" 
    - OML_IPADDR_APPLAN=$(doctl compute droplet list |grep cicd-app.${CI_JOB_ID} |awk '{print $4}') && echo "$OML_IPADDR to run tests" 
    - rm -rf ~/omldeploytool
    - git clone --branch $CI_COMMIT_BRANCH https://gitlab.com/omnileads/omldeploytool.git ~/omldeploytool
    - mkdir -p ~/omldeploytool/systemd/instances/gitlab
    - cd ~/omldeploytool/systemd 
    - cp inventory_ait.yml instances/gitlab/inventory.yml
    - sed -i "6 s/X.X.X.X/$OML_IPADDR_DATA/g" ./instances/gitlab/inventory.yml
    - sed -i "7 s/Z.Z.Z.Z/$OML_IPADDR_DATALAN/g" ./instances/gitlab/inventory.yml
    - sed -i "11 s/X.X.X.X/$OML_IPADDR_VOICE/g" ./instances/gitlab/inventory.yml
    - sed -i "12 s/Z.Z.Z.Z/$OML_IPADDR_VOICELAN/g" ./instances/gitlab/inventory.yml
    - sed -i "16 s/X.X.X.X/$OML_IPADDR_APP/g" ./instances/gitlab/inventory.yml
    - sed -i "17 s/Z.Z.Z.Z/$OML_IPADDR_APPLAN/g" ./instances/gitlab/inventory.yml
    - bash -x deploy.sh --action=install --tenant=gitlab
    - until curl -sk --head --request GET https://$OML_IPADDR_APP |grep "302" > /dev/null; do echo "Environment still being installed, sleeping 60 seconds"; sleep 60; done; echo "Environment is up"
    - sleep 120
    - doctl compute droplet delete -f cicd-app.${CI_JOB_ID}
    - doctl compute droplet delete -f cicd-data.${CI_JOB_ID}
    - doctl compute droplet delete -f cicd-voice.${CI_JOB_ID}
  tags:
    - deploy
  only:
    - /.*pipeline-systemd.*$/
    - /.*pipeline-all.*$/
    - schedules
    - web
    - merge_request

# deploy-ait-lan:
#   stage: deploy
#   environment: DOCTL_DIGITALOCEAN_SYSTEMD
#   script:
#     - rm -rf ~/omldeploytool
#     - git clone --branch $CI_COMMIT_BRANCH https://gitlab.com/omnileads/omldeploytool.git ~/omldeploytool
#     - mkdir -p ~/omldeploytool/systemd/instances/gitlab
#     - cd ~/omldeploytool/systemd
#     - cp inventory_ait.yml instances/gitlab/inventory.yml
#     - sed -i "6 s/X.X.X.X/$PROXMOX_ADDR/g" ./instances/gitlab/inventory.yml
#     - sed -i "7 s/Z.Z.Z.Z/$PROXMOX_ADDR_VM_DATA/g" ./instances/gitlab/inventory.yml
#     - sed -i "11 s/X.X.X.X/$PROXMOX_ADDR/g" ./instances/gitlab/inventory.yml
#     - sed -i "12 s/Z.Z.Z.Z/$PROXMOX_ADDR_VM_VOICE/g" ./instances/gitlab/inventory.yml
#     - sed -i "16 s/X.X.X.X/$PROXMOX_ADDR/g" ./instances/gitlab/inventory.yml
#     - sed -i "17 s/Z.Z.Z.Z/$PROXMOX_ADDR_VM_APP/g" ./instances/gitlab/inventory.yml
#     - sed -i "8 s/22/5701/g" ./instances/gitlab/inventory.yml
#     - sed -i "13 s/22/5702/g" ./instances/gitlab/inventory.yml
#     - sed -i "18 s/22/5703/g" ./instances/gitlab/inventory.yml
#     - sed -i "38 s/cloud/lan/g" ./instances/gitlab/inventory.yml
#     - bash -x deploy.sh --action=install --tenant=gitlab
#     - until curl -sk --head --request GET https://$PROXMOX_ADDR:5704|grep "302" > /dev/null; do echo "Environment still being installed, sleeping 60 seconds"; sleep 60; done; echo "Environment is up"
#   tags:
#     - deploy
#   only:
#     - /.*pipeline-systemd.*$/
#     - /.*pipeline-all.*$/
#     - schedules
#     - web

# deploy-aio-lan:
#   stage: deploy
#   environment: DOCTL_DIGITALOCEAN_SYSTEMD
#   script:
#     - rm -rf ~/omldeploytool
#     - git clone --branch $CI_COMMIT_BRANCH https://gitlab.com/omnileads/omldeploytool.git ~/omldeploytool
#     - mkdir -p ~/omldeploytool/systemd/instances/gitlab
#     - cd ~/omldeploytool/systemd
#     - cp inventory_aio.yml instances/gitlab/inventory.yml
#     - sed -i "s/X.X.X.X/$PROXMOX_ADDR/g" ./instances/gitlab/inventory.yml
#     - sed -i "s/Z.Z.Z.Z/$PROXMOX_ADDR_VM_AIO/g" ./instances/gitlab/inventory.yml
#     - sed -i "8 s/22/5705/g" ./instances/gitlab/inventory.yml
#     - sed -i "27 s/cloud/lan/g" ./instances/gitlab/inventory.yml
#     - bash -x deploy.sh --action=install --tenant=gitlab
#     - until curl -sk --head --request GET https://$PROXMOX_ADDR:5706|grep "302" > /dev/null; do echo "Environment still being installed, sleeping 60 seconds"; sleep 60; done; echo "Environment is up"
#   tags:
#     - deploy
#   only:
#     - /.*pipeline-systemd.*$/
#     - /.*pipeline-all.*$/
#     - schedules
#     - web
